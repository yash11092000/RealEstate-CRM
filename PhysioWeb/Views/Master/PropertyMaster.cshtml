@model PhysioWeb.Models.PropertyMaster

@{
    ViewData["Title"] = "Property Master";
}
<style>
    .stepper {
        list-style: none;
        padding: 0;
        margin: 0;
        display: flex;
        position: relative;
    }

        .stepper .step {
            flex: 1;
            text-align: center;
            font-weight: 500;
            color: #777;
            position: relative;
        }

            .stepper .step span {
                display: inline-block;
                width: 35px;
                height: 35px;
                line-height: 35px;
                border-radius: 50%;
                background: #dcdcdc;
                color: #fff;
                margin-bottom: 5px;
                transition: all 0.3s ease;
            }

            .stepper .step.active span {
                background: #28a745;
                transform: scale(1.1);
            }

            .stepper .step.completed span {
                background: #2ecc71;
            }

            .stepper .step::after {
                content: '';
                position: absolute;
                top: 17px;
                left: 50%;
                width: 100%;
                height: 3px;
                background: #dcdcdc;
                z-index: -1;
            }

            .stepper .step:last-child::after {
                display: none;
            }

            .stepper .step.completed::after {
                background: #2ecc71;
            }

    .gallery-container {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
        gap: 15px;
        justify-items: center;
        margin-top: 15px;
    }

    .preview-card {
        position: relative;
        width: 180px;
        height: 140px;
        border-radius: 8px;
        overflow: hidden;
        background: #ffffff;
        border: 1px solid #e0e0e0;
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.08);
        transition: transform 0.2s ease-in-out;
    }

        .preview-card:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.15);
        }

        .preview-card img,
        .preview-card video {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

    .delete-btn {
        position: absolute;
        top: 5px;
        right: 5px;
        background: rgba(220, 53, 69, 0.9);
        border: none;
        color: #fff;
        font-size: 16px;
        border-radius: 50%;
        width: 24px;
        height: 24px;
        cursor: pointer;
        line-height: 20px;
        text-align: center;
        padding: 0;
        z-index: 10;
        transition: background 0.2s;
    }

        .delete-btn:hover {
            background: #ff1a1a;
        }

    .nav-tabs .nav-link {
        color: #198754; /* Bootstrap success green */
        font-weight: 600;
        border: 2px solid transparent;
        border-radius: 0.5rem 0.5rem 0 0;
        transition: all 0.3s ease-in-out;
    }

        .nav-tabs .nav-link:hover {
            background: #e6f4ea; /* light green hover */
            border-color: #198754;
            color: #198754;
        }

        .nav-tabs .nav-link.active {
            background: #198754;
            color: white !important;
            border-color: #198754;
        }

</style>

<link rel="stylesheet" href="https://cdn.datatables.net/2.3.2/css/dataTables.dataTables.min.css" />



<div class="">
    <ul class="nav nav-tabs mb-3 mt-1" id="agencyMainTabs" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active" id="form-tab" data-bs-toggle="tab" data-bs-target="#formSection" type="button" role="tab">
                📝 Add/Edit Property
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="list-tab" data-bs-toggle="tab" data-bs-target="#listSection" type="button" role="tab">
                📋 Property List
            </button>
        </li>
    </ul>

    <div class="tab-content">
        <div class="tab-pane fade show active" id="formSection" role="tabpanel">

            <div class="container-fluid my-4 p-3 shadow rounded bg-white">
                <h3 class="text-success fw-bold mb-3">Add New Property</h3>

                <div class="progress mb-4" style="height: 8px;">
                    <div class="progress-bar bg-success" role="progressbar" style="width: 25%;"></div>
                </div>

                <!-- Custom Stepper -->
                <ul class="stepper d-flex justify-content-between mb-4">
                    <li class="step active" data-target="#step1"><span>1</span> Basic</li>
                    <li class="step" data-target="#step2"><span>2</span> Location</li>
                    <li class="step" data-target="#step3"><span>3</span> Amenities</li>
                    <li class="step" data-target="#step4"><span>4</span> Review</li>
                </ul>

                <!-- Form -->
                <form id="propertyForm" enctype="multipart/form-data">
                    <div class="tab-content">
                        <input type="text" value="0" id="UniquId" name="UniquId" hidden />
                        <!-- Step 1 -->
                        <div class="tab-pane fade show active" id="step1">
                            <div class="row">
                                <div class="col-md-8 mb-3">
                                    <div class="mb-3">
                                        <label class="form-label fw-bold">
                                            Property Title<span style="color: red;">*</span>
                                        </label>
                                        <input type="text" class="form-control" name="Title" id="Title" placeholder="Enter property title">
                                    </div>
                                </div>
                                <div class="col-md-2 mb-3">
                                    <label class="form-label fw-bold">Year Of Construction</label>
                                    <input type="text" class="form-control" id="YearOfConstruction" name="YearOfConstruction" placeholder="Enter Year of construction">
                                </div>
                                <div class="col-md-2 d-flex " style="align-items:center">
                                    <input class="form-check-input mx-2" type="checkbox" id="IsActive" name="IsActive" value="true" checked />
                                    <label class="form-check-label fw-bold" for="IsActive"> Is Active ?</label>
                                </div>

                            </div>

                            <div class="row">
                                <div class="col-md-4 mb-3">
                                    <label class="form-label fw-bold">Property Type<span style="color: red;">*</span></label>
                                    <select class="form-select" name="PropertyType" id="PropertyType">
                                        <option value="">Select Property Type</option>
                                        @foreach (var item in Model.PropertyTypeList)
                                        {
                                            <option value="@item.Value">@item.Text</option>
                                        }
                                    </select>
                                </div>
                                <div class="col-md-4 mb-3">
                                    <label class="form-label fw-bold">Property Category<span style="color: red;">*</span></label>
                                    <select class="form-select" name="PropertyCategory" id="PropertyCategory">
                                        <option value="">Select Property Category</option>
                                        @foreach (var item in Model.PropertyCategoryList)
                                        {
                                            <option value="@item.Value">@item.Text</option>
                                        }
                                    </select>
                                </div>
                                <div class="col-md-4 mb-3">
                                    <label class="form-label fw-bold">Transaction Type<span style="color: red;">*</span></label>
                                    <select class="form-select" name="TransactionType" id="TransactionType">
                                        <option value="">Select Transaction Type</option>
                                        @foreach (var item in Model.RentalTypeList)
                                        {
                                            <option value="@item.Value">@item.Text</option>
                                        }
                                    </select>
                                </div>

                                <div class="col-md-2 mb-3">
                                    <label class="form-label fw-bold">Bedrooms<span style="color: red;">*</span></label>
                                    <select class="form-select" name="Bedrooms" id="Bedrooms">
                                        <option value="1">Select Bedrooms</option>
                                        @foreach (var item in Model.BedRoomList)
                                        {
                                            <option value="@item.Value">@item.Text</option>
                                        }
                                    </select>
                                </div>

                                <div class="col-md-2 mb-3">
                                    <label class="form-label fw-bold">Bathrooms</label>
                                    <select class="form-select" name="Bathrooms" id="Bathrooms">
                                        <option value="">Select Bathrooms</option>
                                        <option value="1">1</option>
                                        <option value="2">2</option>
                                        <option value="3">3</option>
                                        <option value="4">4+</option>
                                    </select>
                                </div>
                                <div class="col-md-4 mb-3">
                                    <label class="form-label fw-bold">Property Size (sq. ft.)<span style="color: red;">*</span></label>
                                    <input type="number" class="form-control" id="CarpetArea" name="CarpetArea" placeholder="Enter area">
                                </div>
                                <div class="col-md-2 mb-3">
                                    <label class="form-label fw-bold">Floor</label>
                                    <input type="text" class="form-control" id="Floor" name="Floor" placeholder="Enter Floor">
                                </div>
                                <div class="col-md-2 mb-3">
                                    <label class="form-label fw-bold">Total Floor</label>
                                    <input type="text" class="form-control" id="TotalFloorBuilding" name="TotalFloorBuilding" placeholder="Enter Total Floor">
                                </div>

                                <div class="col-md-4 mb-3">
                                    <label class="form-label fw-bold">Furnishing Type<span style="color: red;">*</span></label>
                                    <select class="form-select" name="Furnishing" id="FurnishingStatus">
                                        <option value="">Select Furnishing Type</option>
                                        @foreach (var item in Model.FurnishingTypeList)
                                        {
                                            <option value="@item.Value">@item.Text</option>
                                        }
                                    </select>
                                </div>
                                <div class="col-md-4 mb-3">
                                    <label class="form-label fw-bold">Vastu</label>
                                    <input type="text" class="form-control" id="Vastu" name="Vastu" placeholder="Enter Vastu Direction">
                                </div>
                                <div class="col-md-4 mb-3">
                                    <label class="form-label fw-bold">Preferred Buyer Type</label>
                                    <select class="form-select" name="PreferedBuyerType" id="PreferedBuyerType">
                                        @foreach (var item in Model.PreferedBuyerTypeList)
                                        {
                                            <option value="@item.Value">@item.Text</option>
                                        }
                                    </select>
                                </div>
                            </div>

                            <div class="row">
                                <div class="col-md-4 mb-3">
                                    <label class="form-label fw-bold">Contact Person Name<span style="color: red;">*</span></label>
                                    <input type="text" class="form-control" id="ContactPersonName" name="ContactPersonName" placeholder="Enter Contact Person Name">
                                </div>

                                <div class="col-md-4 mb-3">
                                    <label class="form-label fw-bold">Contact No<span style="color: red;">*</span></label>
                                    <input type="tel" class="form-control" id="ContactPersonNo" name="ContactPersonNo" placeholder="Enter Contact No">
                                </div>

                                <div class="col-md-4 mb-3">
                                    <label class="form-label fw-bold">Alternate No</label>
                                    <input type="text" class="form-control" id="ContactPersonAlternatePhone" name="ContactPersonAlternatePhone" placeholder="Enter Alternate No">
                                </div>

                            </div>

                            <div class="row">
                                <div class="mb-3">
                                    <label class="form-label fw-bold">Description</label>
                                    <textarea class="form-control" name="Description" id="Description" rows="3" placeholder="Enter property description"></textarea>
                                </div>
                            </div>

                            <button type="button" class="btn btn-success next-step">Next</button>
                        </div>


                        <!-- Step 2 -->
                        <div class="tab-pane fade" id="step2">
                            <div class="row">
                                <div class="col-md-4 mb-3">
                                    <label class="form-label fw-bold">Area <span style="color: red;">*</span></label>
                                    <select class="form-select" name="Area" id="Area">
                                        <option value="">Select Area</option>
                                        @foreach (var item in Model.AreaList)
                                        {
                                            <option value="@item.Value">@item.Text</option>
                                        }
                                    </select>
                                </div>
                                <div class="col-md-4 mb-3">
                                    <label class="form-label fw-bold">SubArea</label>
                                    <input type="text" class="form-control" name="SubArea" id="SubArea" placeholder="Enter SubArea">
                                </div>
                                <div class="col-md-4 mb-3">
                                    <label class="form-label fw-bold">Pincode<span style="color: red;">*</span></label>
                                    <input type="text" class="form-control" name="PinCode" id="PinCode" placeholder="Enter Pincode">
                                </div>
                                <div class="col-md-4 mb-3">
                                    <label class="form-label fw-bold">Country</label>
                                    <select class="form-select" name="Country" id="Country">
                                        <option value="">Select Country</option>
                                        @foreach (var item in Model.CountryList)
                                        {
                                            <option value="@item.Value">@item.Text</option>
                                        }
                                    </select>
                                </div>
                                <div class="col-md-4 mb-3">
                                    <label class="form-label fw-bold">State</label>
                                    <select class="form-select" name="State" id="State">
                                        <option value="">Select State</option>
                                        @foreach (var item in Model.StateList)
                                        {
                                            <option value="@item.Value">@item.Text</option>
                                        }
                                    </select>
                                </div>
                                <div class="col-md-4 mb-3">
                                    <label class="form-label fw-bold">City</label>
                                    <select class="form-select" name="City" id="City">
                                        <option value="">Select City</option>
                                        @foreach (var item in Model.CityList)
                                        {
                                            <option value="@item.Value">@item.Text</option>
                                        }
                                    </select>
                                </div>


                            </div>
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label class="form-label fw-bold">Address</label>
                                    <input type="text" class="form-control" name="Address" id="Address" placeholder="Enter full address">
                                </div>

                                <div class=" col-md-6 mb-3">
                                    <label class="form-label fw-bold">Landmark</label>
                                    <input type="text" class="form-control" name="Landmark" id="LandMark" placeholder="Add Schools, metros, hospitals nearby landmark">
                                </div>
                            </div>

                            <div class="row mb-3">
                                <div class="col-md-3">
                                    <label class="form-label fw-bold">Actual Price</label>
                                    <div class="input-group">
                                        <span class="input-group-text">₹</span>
                                        <input type="number" class="form-control" name="BudgetMax" id="BudgetMax" placeholder="Enter amount">
                                        <select id="AmountUnitMaxPrice" class="form-select" style="max-width: 100px;  background-color: #a9a9a96b;">
                                            @foreach (var item in Model.AmountUnitList)
                                            {
                                                <option value="@item.Value">@item.Text</option>
                                            }
                                        </select>
                                    </div>
                                    <span id="displayMaxBudget" class="text-success fw-bold"></span>
                                </div>

                                <div class="col-md-2 mt-3">
                                    <div class="form-check pt-4">
                                        <input class="form-check-input" type="checkbox" id="IsNegotiable" name="IsNegotiable" value="true" checked />
                                        <label class="form-check-label" for="IsNegotiable">Negotiable</label>
                                    </div>
                                </div>

                                <div class="col-md-3 negotiableprice fw-bold" style="display: none;">
                                    <label class="form-label">Negotiable Price</label>
                                    <div class="input-group">
                                        <span class="input-group-text">₹</span>
                                        <input type="number" class="form-control" name="PriceMin" id="BudgetMin" placeholder="Enter amount">
                                        <select id="AmountUnitMinPrice" class="form-select" style="max-width: 100px; background-color: #a9a9a96b;">
                                            @foreach (var item in Model.AmountUnitList)
                                            {
                                                <option value="@item.Value">@item.Text</option>
                                            }
                                        </select>
                                    </div>
                                    <span id="displayMinBudget" class="text-success fw-bold"></span>

                                </div>

                            </div>

                            <input type="hidden" id="ConvertedActualPrice" value="0" name="ConvertedActualPrice" />
                            <input type="hidden" id="ConvertedNegotiablePrice" value="0" name="ConvertedNegotiablePrice" />
                            <button type="button" class="btn btn-light prev-step">Back</button>
                            <button type="button" class="btn btn-success next-step">Next</button>
                        </div>


                        <!-- Step 3 -->
                        <div class="tab-pane fade" id="step3">
                            <div class="mb-3">
                                <label class="form-label fw-bold">Amenities</label>
                                <select class="form-select" name="Amenities" id="Amenities" multiple>
                                    @foreach (var item in Model.AmenityList)
                                    {
                                        <option value="@item.Value">@item.Text</option>
                                    }
                                </select>
                            </div>

                            <!-- Image Upload -->
                            <div class="mb-3">
                                <label class="form-label fw-bold">Upload Images</label>
                                <div id="imageInputs">
                                    <input type="file" name="Images" id="Images" class="form-control mb-2 imageInput" accept="image/*">
                                </div>
                                <button type="button" id="addImageInput" class="btn btn-outline-success btn-sm">+ Add More Images</button>
                            </div>

                            <div id="imageGallery" class="gallery-container"></div>

                            <hr>

                            <!-- Video Upload -->
                            <div class="mb-3">
                                <label class="form-label fw-bold">Upload Videos</label>
                                <div id="videoInputs">
                                    <input type="file" name="Videos" id="Videos" class="form-control mb-2 videoInput" accept="video/*">
                                </div>
                                <button type="button" id="addVideoInput" class="btn btn-outline-success btn-sm">+ Add More Videos</button>
                            </div>

                            <div id="videoGallery" class="gallery-container"></div>


                            <button type="button" class="btn btn-light prev-step">Back</button>
                            <button type="button" class="btn btn-success next-step">Next</button>
                        </div>


                        <!-- Step 4 -->
                        <div class="tab-pane fade" id="step4">
                            <h5 class="text-success">Review Your Property Details</h5>
                            <p class="text-muted">You can review all information before submitting.</p>
                            <button type="button" class="btn btn-light prev-step">Back</button>
                            <button type="button" id="submitProperty" class="btn btn-success">Submit Property</button>
                        </div>

                    </div>
                </form>
            </div>
        </div>
        <div class="tab-pane fade" id="listSection" role="tabpanel">
            <div class="card shadow-sm p-3">
                <h5>All Properties</h5>
                <table id="TableList" class="table table-bordered table-striped w-100">
                    <thead>
                        <tr>
                            <th>Property Name</th>
                            <th>Property Type</th>
                            <th>Transaction Type</th>
                            <th>City</th>
                            <th>Contact Person Name</th>
                            <th>IsActive</th>
                            <th>Created By </th>
                            <th><i class="bi bi-eye text-primary fs-5" title="View"></i></th>
                            <th><i class="bi bi-check2-circle text-primary fs-5" title="Sold Out Details"></i></th>
                            <th><i class="bi bi-pencil-square text-primary fs-5" title="Edit"></i></th>
                            <th><i class="bi bi-trash text-danger fs-5" title="Delete"></i></th>
                        </tr>
                    </thead>
                </table>
            </div>
        </div>
    </div>
</div>


<!-- ✅ Add Property Type Modal -->
<div class="modal fade" id="addSoldoutModal" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title">Add Sold Out Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="SoldOutModalForm">
                    <input type="hidden" id="PropUniquId" name="PropUniquId" />
                    <div class="mb-3">
                        <label class="form-label fw-bold">Sold Out To Whome Name<span class="impMark">*</span></label>
                        <input type="text" class="form-control" id="SoldOutToWhome" name="SoldOutToWhome" placeholder="Enter Sold Out To Whome Name" />
                    </div>
                    <div class="mb-3">
                        <label class="form-label fw-bold">Sold Out Contact No</label>
                        <input type="text" class="form-control" id="SoldOutContactNo" name="SoldOutContactNo" placeholder="Enter Sold Out Contact No">
                    </div>
                    <div class="form-check mb-3">
                        <input class="form-check-input" type="checkbox" id="IsSoldOut" name="IsSoldOut" value="false" />
                        <label class="form-check-label fw-bold" for="IsSoldOutLabel">Is Sold Out</label>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">
                    <i class="bi bi-x-circle"></i> Cancel
                </button>
                <button type="button" class="btn btn-success" id="btnSaveSoldOut">
                    <i class="bi bi-save"></i> Save
                </button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script src="https://cdn.datatables.net/2.3.2/js/dataTables.min.js"></script>
    <script>

            $(document).ready(function () {
                if ($("#IsNegotiable").is(":checked")) {
            $(".negotiableprice").show();
        } else {
            $(".negotiableprice").hide();
        }
                                            // Clone header row for filters
        $('#TableList thead tr').clone(true).appendTo('#TableList thead');

        $('#TableList thead tr:eq(1) th').each(function (i) {
            if ($(this).find('i').length === 0) { // ✅ only add input if no icon
                var title = $('#TableList thead tr:eq(0) th').eq(i).text().trim();
                $(this).html('<input class="form-control form-control-sm" type="text" placeholder="' + title + '" />');
            } else {
                $(this).html('');
            }
        });

        var TableList = $("#TableList").DataTable({
            orderCellsTop: true,
            processing: true,
            serverSide: true,
            order: [[0, "asc"]],
            ajax: {
                url: '/Master/ListPropertyMaster', // ✅ Update to your actual action
                type: 'POST',
            },
            columns: [
                { data: 'title' },                // Property Name
                { data: 'propertyType' },         // Property Type
                { data: 'transactionType' },      // Transaction Type
                { data: 'cityText' },              // City
                { data: 'contactPersonName' },    // Contact Person Name
                { data: 'inActiveText' },         // Is Active
                { data: 'createdBy' },            // Created By

                // View Icon Column
                {
                    data: null,
                    render: function (data, type, row) {
                        let para = `'${row.uniquId}', 'Master', 'ViewProperty'`;
                        return `<a href="javascript:void(0)" onclick="ViewData(${para})">
                                    <i class="bi bi-eye text-primary fs-5" title="View"></i>
                                </a>`;
                    },
                    orderable: false,
                    searchable: false
                },
                        {
            data: null,
            render: function (data, type, row) {
                return `<a href="javascript:void(0)" onclick="SoldOutData(${row.uniquId})">
                            <i class="bi bi-check2-circle text-primary fs-5" title="Sold Out Details"></i>
                        </a>`;
            },
            orderable: false,
            searchable: false
        }
        ,				// Edit Icon Column
                {
                    data: null,
                    render: function (data, type, row) {
                        let para = `'${row.uniquId}', 'Master', 'EditProperty'`;
                        return `<a href="javascript:void(0)" onclick="EditData(${para})">
                                    <i class="bi bi-pencil-square text-primary fs-5" title="Edit"></i>
                                </a>`;
                    },
                    orderable: false,
                    searchable: false
                },

                // Delete Icon Column
                {
                    data: null,
                    render: function (data, type, row) {
                        let para = `'${row.uniquId}', 'Master', 'DeleteProperty'`;
                        return `<a href="javascript:void(0)" onclick="DeleteData(${para})">
                                    <i class="bi bi-trash text-danger fs-5" title="Delete"></i>
                                </a>`;
                    },
                    orderable: false,
                    searchable: false
                }
            ],
            initComplete: function () {
                var table = this.api();
                $('#TableList thead tr:eq(1) th').each(function (i) {
                    $('input', this).on('keyup change', function () {
                        if (table.column(i).search() !== this.value) {
                            table
                                .column(i)
                                .search(this.value)
                                .draw();
                        }
                    });
                });
            }
        });


                            });

        new Choices('#Amenities', {
            removeItemButton: true,
            placeholder: true,
            placeholderValue: 'Select Amenities',
            searchEnabled: true
        });

                                function isValidFile(file, allowedTypes) {
                                    return file.size > 0 && allowedTypes.some(type => file.type.startsWith(type));
                                }

                                function updateProgress(stepIndex) {
            let totalSteps = $(".step").length;
            let percent = ((stepIndex + 1) / totalSteps) * 100;
            $(".progress-bar").css("width", percent + "%");
        }

        function goToStep(stepIndex) {
            // ✅ Only target stepper tab-panes inside the form
            $("#formSection .tab-pane").removeClass("show active")
                .eq(stepIndex).addClass("show active");

            // ✅ Update step indicators
            $(".step").removeClass("active completed").each(function (index) {
                if (index < stepIndex) $(this).addClass("completed");
                if (index === stepIndex) $(this).addClass("active");
            });

            updateProgress(stepIndex);
        }

        // ✅ Click on step indicators
        $(document).on("click", ".step", function () {
            goToStep($(this).index());
        });

        // ✅ Next button
        $(document).on("click", ".next-step", function () {
            let currentIndex = $(".step.active").index();
            if (currentIndex < $(".step").length - 1) goToStep(currentIndex + 1);
        });

        // ✅ Previous button
        $(document).on("click", ".prev-step", function () {
            let currentIndex = $(".step.active").index();
            if (currentIndex > 0) goToStep(currentIndex - 1);
        });


                                // $(document).ready(function () {
                                // 	function updateProgress(stepIndex) {
                                // 		let totalSteps = $(".step").length;
                                // 		let percent = ((stepIndex + 1) / totalSteps) * 100;
                                // 		$(".progress-bar").css("width", percent + "%");
                                // 	}

                                // 	function goToStep(stepIndex) {
                                // 		$(".tab-pane").removeClass("show active").eq(stepIndex).addClass("show active");
                                // 		$(".step").removeClass("active completed");
                                // 		$(".step").each(function (index) {
                                // 			if (index < stepIndex) $(this).addClass("completed");
                                // 			if (index === stepIndex) $(this).addClass("active");
                                // 		});
                                // 		updateProgress(stepIndex);
                                // 	}

                                // 	$(document).on("click", ".step", function () {
                                // 		goToStep($(this).index());
                                // 	});

                                // 	$(document).on("click", ".next-step", function () {
                                // 		let currentIndex = $(".step.active").index();
                                // 		if (currentIndex < $(".step").length - 1) goToStep(currentIndex + 1);
                                // 	});

                                // 	$(document).on("click", ".prev-step", function () {
                                // 		let currentIndex = $(".step.active").index();
                                // 		if (currentIndex > 0) goToStep(currentIndex - 1);
                                // 	});
                                // });

                                            function createPreview(input, file, type) {
                    const gallery = type === "image" ? document.getElementById("imageGallery") : document.getElementById("videoGallery");

                    // Remove old preview for this input
                    const oldPreview = gallery.querySelector(`[data-input-id="${input.dataset.id}"]`);
                    if (oldPreview) oldPreview.remove();

                    const fileURL = URL.createObjectURL(file);
                    const card = document.createElement("div");
                    card.classList.add("preview-card");
                    card.dataset.inputId = input.dataset.id;

                    card.innerHTML = `
                        <button type="button" class="delete-btn">&times;</button>
                        ${type === "image"
                            ? `<img src="${fileURL}" alt="Preview">`
                            : `<video controls><source src="${fileURL}" type="${file.type}"></video>`}
                    `;

                    gallery.appendChild(card);

                    // Delete functionality
                    card.querySelector(".delete-btn").addEventListener("click", () => {
                        URL.revokeObjectURL(fileURL);
                        card.remove();
                        input.remove();
                    });
                }

                function isValid(file, prefix) {
                    return file && file.type.startsWith(prefix);
                }

                function handlePreview(e, type) {
                    const input = e.target;
                    const file = input.files[0];
                    if (!file) return;

                    if (!isValid(file, type + "/")) {
                        alert(`Invalid ${type} file: ${file.name}`);
                        input.value = "";
                        return;
                    }

                    createPreview(input, file, type);
                }

                let inputCounter = 0;
                function assignInputId(input) {
                    input.dataset.id = "input-" + (++inputCounter);
                }

                document.addEventListener("change", function (e) {
                    if (e.target.classList.contains("imageInput")) handlePreview(e, "image");
                    if (e.target.classList.contains("videoInput")) handlePreview(e, "video");
                });

                // Add Image Input
                document.getElementById("addImageInput").addEventListener("click", () => {
                    const newInput = document.createElement("input");
                    newInput.type = "file";
                    newInput.name = "Images";
                    newInput.accept = "image/*";
                    newInput.classList.add("form-control", "mb-2", "imageInput");
                    assignInputId(newInput);
                    document.getElementById("imageInputs").appendChild(newInput);
                });

                // Add Video Input
                document.getElementById("addVideoInput").addEventListener("click", () => {
                    const newInput = document.createElement("input");
                    newInput.type = "file";
                    newInput.name = "Videos";
                    newInput.accept = "video/*";
                    newInput.classList.add("form-control", "mb-2", "videoInput");
                    assignInputId(newInput);
                    document.getElementById("videoInputs").appendChild(newInput);
                });

                // Assign IDs to initial inputs
                document.querySelectorAll(".imageInput, .videoInput").forEach(assignInputId);


            $("#submitProperty").on("click", function (e) {
            e.preventDefault();

            // ✅ Collect all fields into an object
            var propertyMaster = {
                UniquId : $("#UniquId").val(),
                Title: $("#Title").val(),
                PropertyType: $("#PropertyType").val(),
                TransactionType: $("#TransactionType").val(),
                Bedrooms: $("#Bedrooms").val(),
                Bathrooms: $("#Bathrooms").val(),
                CarpetArea: $("#CarpetArea").val(),
                //BuiltUpArea: $("#BuiltUpArea").val(),
                FurnishingStatus: $("#FurnishingStatus").val(),
                Floor: $("#Floor").val(),
                ContactPersonName: $("#ContactPersonName").val(),
                ContactPersonNo: $("#ContactPersonNo").val(),
                ContactPersonAlternatePhone: $("#ContactPersonAlternatePhone").val(),
                Description: $("#Description").val(),
                Area: $("#Area").val(),
                SubArea: $("#SubArea").val(),
                PinCode: $("#PinCode").val(),
                Country: $("#Country").val(),
                State: $("#State").val(),
                City: $("#City").val(),
                Address: $("#Address").val(),
                BudgetMin: $("#BudgetMin").val(),
                BudgetMax: $("#BudgetMax").val(),
                Amenities: $("#Amenities").val().toString(),
                //PossessionDate: $("#PossessionDate").val(),
                IsActive: $("#IsActive").is(":checked"),
                Vastu : $("#Vastu").val(),
                YearOfConstruction : $("#YearOfConstruction").val(),
                PropertyCategory : $("#PropertyCategory").val(),
                PreferedBuyerType :$("#PreferedBuyerType").val(),
                AmountUnitMinPrice :$("#AmountUnitMinPrice").val(),
                AmountUnitMaxPrice :$("#AmountUnitMaxPrice").val(),
                ConvertedActualPrice : $("#ConvertedActualPrice").val(),
                ConvertedNegotiablePrice : $("#ConvertedNegotiablePrice").val(),
                TotalFloorBuilding : $("#TotalFloorBuilding").val(),
                IsNegotiable : $("#IsNegotiable").is(":checked"),

            };

            // ✅ Create FormData

            // ✅ Send AJAX request
            $.ajax({
                url: "/Master/SaveProperty",
                type: "POST",
                contentType: "application/json",
                data: JSON.stringify(propertyMaster),
                success: function (res) {
                    console.log(res);
                    if (res.success) {
                        notyf.success("Property details saved!");
                        InsertImagesVideos(res.propertyId);

                        $("#TableList").DataTable().ajax.reload(null, false);
                        ClearData();
                    } else {
                        notyf.error(res.message || "Failed to save property");
                    }
                },
                error: function () {
                    notyf.error("Error while saving property details.");
                }
            });
        });

        function InsertImagesVideos(propertyId){
            if(!propertyId || propertyId<=0){
                notyf.error("Property ID missing! Save property details first.");
                return;
            }

        let formData = new FormData();
        formData.append("PropertyId", propertyId); // ✅ link media with property

                 const MAX_FILE_SIZE = 50 * 1024 * 1024; // 50 MB

        // Validate image sizes
        document.querySelectorAll("#imageInputs input[type='file']").forEach(input => {
            if (input.files[0]?.size > MAX_FILE_SIZE) {
                notyf.error(`Image ${input.files[0].name} exceeds 50MB`);
                return;
            }
        });

        // Validate video sizes
        document.querySelectorAll("#videoInputs input[type='file']").forEach(input => {
            if (input.files[0]?.size > MAX_FILE_SIZE) {
                notyf.error(`Video ${input.files[0].name} exceeds 50MB`);
                return;
            }
        });


              const imageInputs = document.querySelectorAll("#imageInputs input[type='file']");
        Array.from(imageInputs).forEach((input, index) => {
            if (input.files[0]) {
                formData.append(`Images[${index}]`, input.files[0]); // ✅ Correct format
            }
        });

        // Append Videos (with array indices)
        const videoInputs = document.querySelectorAll("#videoInputs input[type='file']");
        Array.from(videoInputs).forEach((input, index) => {
            if (input.files[0]) {
                formData.append(`Videos[${index}]`, input.files[0]); // ✅ Correct format
            }
        });

        // Optional: Debug FormData before sending
        for (let pair of formData.entries()) {
            console.log(pair[0], pair[1]);
        }
             $.ajax({
            url: "/Master/UploadPropertyMedia",
            type: "POST",
            data: formData,
            processData: false,
            contentType: false,
            success: function (res) {
                if (res.success) {
                    notyf.success("Property media uploaded successfully!");
                } else {
                    notyf.error(res.message || "Failed to upload media");
                }
            },
            error: function () {
                notyf.error("Error while uploading media.");
            }
        });
        }

        $(document).on("change", "#Area", function () {
            AreaID = $("#Area").val();
            $.ajax({
            type: "POST",
            url: "/Master/GetAreaMasterData",
            data: { AreaID: AreaID },
            success: function (data) {
                console.log(data)
                 if (data != "") {
                    $("#SubArea").val(data.subArea);
                    $("#PinCode").val(data.pinCode);
                    $("#Country").val(data.country);
                    $("#State").val(data.state);
                    $("#City").val(data.city);
                 } else {
                     $("#SubArea").val("");
                    $("#PinCode").val("");
                    $("#Country").val("");
                    $("#State").val("");
                    $("#City").val("");
                 }
            },
            error: function (xhr, status, error) {

                //console.error("Error fetching data for Edit:", error);
                alert("An error occurred while fetching data.");
            }
        });
        });

         function OnSuccessOfDelete() {
            notyf.success("Property Deleted");
        }

          function ClearData() {
                $("#UniquId").val("");
                $("#IsActive").prop("checked", true);
                $("#Amenities").val("");
            }


            function OnSuccessOfEdit(data) {

            // ✅ Switch tab first
            var triggerTab = new bootstrap.Tab(document.querySelector('#form-tab'));
            triggerTab.show();
            console.log(data);
            // ✅ Now bind form values
            $("#UniquId").val(data.uniquId);
            $("#Title").val(data.title);
            $("#PropertyType").val(data.propertyType);
            $("#Bedrooms").val(data.bedrooms);
            $("#TransactionType").val(data.transactionType);
            $("#PropertyCategory").val(data.propertyCategory);
            $("#Bathrooms").val(data.bathrooms);
            $("#CarpetArea").val(data.carpetArea);
            $("#Floor").val(data.Floor);
            $("#TotalFloorBuilding").val(data.totalFloorBuilding);
            $("#FurnishingStatus").val(data.furnishingStatus);
            $("#Vastu").val(data.vastu);
            $("#PreferedBuyerType").val(data.preferedBuyerType);
            $("#YearOfConstruction").val(data.yearOfConstruction);
            $("#Description").val(data.description);
            $("#ContactPersonName").val(data.contactPersonName);
            $("#ContactPersonPhone").val(data.contactPersonPhone);
            $("#ContactPersonAlternatePhone").val(data.contactPersonAlternatePhone);
            $("#Area").val(data.area);
            $("#SubArea").val(data.subArea);
            $("#City").val(data.city);
            $("#State").val(data.state);
            $("#Country").val(data.country);
            $("#Address").val(data.address);
            $("#Landmark").val(data.landmark);
            $("#BudgetMax").val(data.convertedActualPrice);
            $("#BudgetMin").val(data.convertedNegotiablePrice);
            $("#displayMaxBudget").val(data.budgetMax);
            $("#ConvertedNegotiablePrice").val(data.convertedNegotiablePrice);
            $("#displayMinBudget").val(data.budgetMin);
            $("#ConvertedActualPrice").val(data.convertedActualPrice);
            $("#Amenities").val(data.amenities);
            //	showMediaFromPaths(data.images, "imageGallery", "image");
        //showMediaFromPaths(data.videos, "videoGallery", "video");
            // If checkbox
             $("#IsNegotiable").prop("checked", data.isNegotiable);
             $("#IsActive").prop("checked", data.isActive);
        }

        document.querySelectorAll(".imageInput, .videoInput").forEach(assignInputId);

                        function handleFilePreview(input, containerId, type) {
            const files = input.files;
            const container = document.getElementById(containerId);
            container.innerHTML = "";

            Array.from(files).forEach(file => {
                const reader = new FileReader();
                reader.onload = function (e) {
                    let element;
                    if (type === "image") {
                        element = document.createElement("img");
                        element.src = e.target.result;
                        element.style.width = "120px";
                        element.style.height = "100px";
                        element.classList.add("rounded", "border");
                    } else if (type === "video") {
                        element = document.createElement("video");
                        element.src = e.target.result;
                        element.controls = true;
                        element.style.width = "200px";
                        element.style.height = "150px";
                        element.classList.add("rounded", "border");
                    }
                    container.appendChild(element);
                };
                reader.readAsDataURL(file);
            });
        }

        // // ✅ Event delegation for dynamically added inputs
        // document.addEventListener("change", function (e) {
        // 	if (e.target.classList.contains("imageInput")) {
        // 		handleFilePreview(e.target, "imageGallery", "image");
        // 	}
        // 	if (e.target.classList.contains("videoInput")) {
        // 		handleFilePreview(e.target, "videoGallery", "video");
        // 	}
        // });

        // // ✅ Add more input fields dynamically
        // document.getElementById("addImageInput").addEventListener("click", function () {
        // 	const newInput = document.createElement("input");
        // 	newInput.type = "file";
        // 	newInput.name = "Images";
        // 	newInput.accept = "image/*";
        // 	newInput.classList.add("form-control", "mb-2", "imageInput");
        // 	document.getElementById("imageInputs").appendChild(newInput);
        // });

        // document.getElementById("addVideoInput").addEventListener("click", function () {
        // 	const newInput = document.createElement("input");
        // 	newInput.type = "file";
        // 	newInput.name = "Videos";
        // 	newInput.accept = "video/*";
        // 	newInput.classList.add("form-control", "mb-2", "videoInput");
        // 	document.getElementById("videoInputs").appendChild(newInput);
        // });


        $(document).on("change", "#IsNegotiable", function () {
            if ($(this).is(":checked")) {
                $(".negotiableprice").show();
            } else {
                $(".negotiableprice").hide();
            }
        });


            function convertValue(amount, unit) {
            let multiplier = 1;

            switch (unit) {
                case "1": // Cr
                    multiplier = 10000000;
                    break;
                case "2": // Lac
                    multiplier = 100000;
                    break;
                case "3": // K
                    multiplier = 1000;
                    break;
                case "4": // Rs
                    multiplier = 1;
                    break;
            }

            return amount * multiplier;
        }

        // Convert Actual Price
        function convertActualPrice() {
            let price = parseFloat($("#BudgetMax").val()) || 0;
            let unit = $("#AmountUnitMaxPrice").val();
            let converted = convertValue(price, unit);
            let formatted = formatIndianNumber(converted);

            $("#ConvertedActualPrice").val(converted);
                    $("#displayMaxBudget").text(`₹ ${formatted}`);

            console.log("Converted Actual Price:", formatted);
        }

        // Convert Negotiable Price
        function convertNegotiablePrice() {
            let price = parseFloat($("#BudgetMin").val()) || 0;
            let unit = $("#AmountUnitMinPrice").val();
            let converted = convertValue(price, unit);
            let formatted = formatIndianNumber(converted);

            $("#ConvertedNegotiablePrice").val(converted);

        $("#displayMinBudget").text(`₹ ${formatted}`);
                    console.log("Converted Negotiable Price:", formatted);
        }

        // Trigger conversion when user types or changes dropdown
        $(document).on("keyup change", "#BudgetMax, #AmountUnitMaxPrice", convertActualPrice);
        $(document).on("keyup change", "#BudgetMin, #AmountUnitMinPrice", convertNegotiablePrice);

        // Negotiable checkbox toggle
        $(document).on("change", "#IsNegotiable", function () {
            if ($(this).is(":checked")) {
                $(".negotiableprice").show();
            } else {
                $(".negotiableprice").hide();
                $("#ConvertedNegotiablePrice").val(0); // reset if hidden
            }
        });

        function formatIndianNumber(num) {
            if (isNaN(num)) return "0";

            // Convert to string and split into parts
            let numStr = num.toString();
            let parts = numStr.split('.');
            let wholeNumber = parts[0];
            let decimal = parts.length > 1 ? '.' + parts[1] : '';

            // Format the whole number part
            let lastThree = wholeNumber.substring(wholeNumber.length - 3);
            let otherNumbers = wholeNumber.substring(0, wholeNumber.length - 3);

            if (otherNumbers !== '') {
                lastThree = ',' + lastThree;
            }

            let result = otherNumbers.replace(/\B(?=(\d{2})+(?!\d))/g, ",") + lastThree + decimal;

            return result.replace(/^,/, '');
        }

        function validatePropertyMaster() {
            const requiredFields = [
                { id: "#Title", msg: "Please enter Title" },
                { id: "#PropertyType", msg: "Please select Property Type" },
                { id: "#TransactionType", msg: "Please select Transaction Type" },
                { id: "#Bedrooms", msg: "Please enter number of Bedrooms" },
                // { id: "#Bathrooms", msg: "Please enter number of Bathrooms" },
                { id: "#CarpetArea", msg: "Please enter Property Size (sq. ft.)" },
                { id: "#FurnishingStatus", msg: "Please select Furnishing Type" },
                // { id: "#Floor", msg: "Please enter Floor" },
                { id: "#ContactPersonName", msg: "Please enter Contact Person Name" },
                { id: "#ContactPersonNo", msg: "Please enter Contact Person Number" },
                { id: "#Description", msg: "Please enter Description" },
                { id: "#Area", msg: "Please select Area" },
                { id: "#SubArea", msg: "Please select Sub Area" },
                { id: "#PinCode", msg: "Please enter Pin Code" },
                { id: "#Country", msg: "Please select Country" },
                { id: "#State", msg: "Please select State" },
                { id: "#City", msg: "Please select City" },
                { id: "#Address", msg: "Please enter Address" },
                { id: "#BudgetMax", msg: "Please enter Actual Price" },
                { id: "#AmountUnitMinPrice", msg: "Please select Price Unit" }
            ];

            // ✅ Loop through required fields
            for (let field of requiredFields) {
                if (!$(field.id).val() || $(field.id).val().trim() === "") {
                    notyf.error(field.msg);
                    $(field.id).focus();
                    return false;
                }
            }

            // ✅ Extra: check Negotiable Price if checkbox is checked
            if ($("#IsNegotiable").is(":checked")) {
                if (!$("#BudgetMin").val() || $("#BudgetMin").val().trim() === "") {
                    notyf.error("Please enter Negotiable Price");
                    $("#BudgetMin").focus();
                    return false;
                }
                if (!$("#AmountUnitMinPrice").val()) {
                    notyf.error("Please select Negotiable Price Unit");
                    $("#AmountUnitMinPrice").focus();
                    return false;
                }
            }

            return true; // ✅ Passed all validations
        }
                function showMediaFromPaths(paths, containerId, type) {
            const container = document.getElementById(containerId);
            container.innerHTML = ""; // clear only once when loading DB data

            if (paths && paths.length > 0) {
                paths.forEach(path => createPreviewFromPath(path, type, containerId));
            }
        }

                function createPreviewFromPath(path, type, containerId) {
            const gallery = document.getElementById(containerId);
            const card = document.createElement("div");
            card.classList.add("preview-card");

            card.innerHTML = `
                <button type="button" class="delete-btn">&times;</button>
                ${type === "image"
                    ? `<img src="/secure-images/${path}" alt="Preview">`
                    : `<video controls><source src="/secure-images/${path}" type="${type}/${path.split('.').pop()}"></video>`}
            `;

            gallery.appendChild(card);

            // Delete functionality
            card.querySelector(".delete-btn").addEventListener("click", () => {
                card.remove();
                // TODO: mark file for deletion in hidden input if needed
            });
        }


           function SoldOutData(uniquId) {
            
            $("#PropUniquId").val(uniquId);

           // var myModal = new bootstrap.Modal(document.getElementById('addSoldoutModal'));
            
                 $.ajax({
            url: '/Master/GetSoldOutDetails', 
            type: 'POST',
            data: { PropUniquId: $("#PropUniquId").val() },
            success: function (data) {
                if (data) {
                 
                    $("#PropUniquId").val(data.propUniquId);
                    $("#SoldOutToWhome").val(data.soldOutToWhome);
                    $("#SoldOutContactNo").val(data.soldOutContactNo);

                    // checkbox mapping
                    if (data.isSoldOut) {
                        $("#IsSoldOut").prop("checked", true).val("true");
                    } else {
                        $("#IsSoldOut").prop("checked", false).val("false");
                    }

                    var modal = new bootstrap.Modal(document.getElementById("addSoldoutModal"));
                    modal.show();
                }
            }
        });
        }
                function SaveSoldOut() {
            var soldOutData = {
                PropUniquId: $("#PropUniquId").val(),
                SoldOutToWhome: $("#SoldOutToWhome").val(),
                SoldOutContactNo: $("#SoldOutContactNo").val(),
                IsSoldOut: $("#IsSoldOut").is(":checked") // true/false
            };

            $.ajax({
                url: '/Master/SaveSoldOutDetails',
                type: 'POST',
                data: soldOutData,
                success: function (response) {
                    if (response.success) {
                        // ✅ close modal
                        $("#addSoldoutModal").modal("hide");

                        // ✅ show message
                        alert("Saved successfully!");

                        // ✅ reload table or refresh data
                        // $("#yourDataTable").DataTable().ajax.reload();
                    } else {
                        alert("Something went wrong while saving.");
                    }
                },
                error: function (xhr, status, error) {
                    console.error(error);
                    alert("Error occurred while saving data.");
                }
            });
        }

    </script>

}
